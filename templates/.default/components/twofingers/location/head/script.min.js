var tf_location_cities_loaded=!1,tf_location_animation_speed=200;function TfLocation(o,t){var e=this;this.params=o,this.callback=t,this.$body=$("body"),this.$bodyChildren=this.$body.children(":not(script):not(style):not(noscript)"),this.mobileWidth=this.params.mobile_width?parseInt(this.params.mobile_width):0,this.LocationsPopup=new TfLocationsPopup(this),this.ConfirmPopup=new TfConfirmPopup(this),this.openLocationsPopup=function(o){this.LocationsPopup.open(o),this.ConfirmPopup.close()},this.openConfirmPopup=function(){this.ConfirmPopup.open(),this.LocationsPopup.close()},this.isMobile=function(){return window.innerWidth<=this.mobileWidth},this.htmlspecialchars=function(o){return"string"==typeof o&&(o=(o=(o=(o=(o=o.replace(/&/g,"&amp;")).replace(/"/g,"&quot;")).replace(/'/g,"&#039;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")),o},this.htmlspecialcharsDecode=function(o){return"string"==typeof o&&(o=(o=(o=(o=(o=o.replace(/&quot;/g,'"')).replace(/&#039;/g,"'")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&amp;/g,"&")),o},this.removeTags=function(o){return"string"==typeof o&&(o=o.replace(/<[^>]+>/g,"")),o},this.clearStr=function(o){return"string"==typeof o&&(o=this.htmlspecialcharsDecode(o),o=this.removeTags(o)),o},this.setLocation=function(o,t,i,n){$.post(e.params.path+"/functions.php",{request:"setcity",requestUri:i,location_id:o},function(o){"function"==typeof t&&t(o)},"json")},this.updateLinks=function(o,t,e){$(".tfl__link").html(t).data("location-id",o).data("location-code",e)},this.removeURLParameters=function(o){const t=new RegExp(o.join("=|")+"="),e=location.search.slice(1).split("&");let i=[];for(let o=0;o<e.length;o++)!1===t.test(e[o])&&i.push(e[o]);window.history.replaceState({},document.title,location.pathname+(i.length?"?"+i.join("&"):"")+location.hash)}}function TfLocationsPopup(TfLocation){var self=this;this.TfLocation=TfLocation,this.callback=TfLocation.callback,this.$body=TfLocation.$body,this.$bodyChildren=TfLocation.$bodyChildren,this.$overlay=this.$body.find(".tfl-popup-overlay"),this.$popup=this.$body.find(".tfl-popup"),this.$overlay.length&&(this.$overlay.length>1?this.$overlay.first().remove():this.$overlay.appendTo(this.$body)),this.componentPath=this.TfLocation.params.path?this.TfLocation.params.path:"",this.requestUri=this.TfLocation.params.request_uri?this.TfLocation.params.request_uri:"/",this.$locationsContainer=this.$popup.find(".tfl-popup__locations"),this.$defaultsContainer=this.$popup.find(".tfl-popup__defaults"),this.Search=new TfLocationsPopupSearch(this),this.isOrderPage=!1,this.onKeyPress=function(o){if(self.isOpened())switch(o.originalEvent.keyCode){case 27:self.close();break;case 38:case 40:try{let t=self.$locationsContainer.getNiceScroll(0),e=t?t.getScrollTop():0,i=38===o.originalEvent.keyCode?e-=500:e+=500;t.length&&self.$locationsContainer.getNiceScroll(0).doScrollTop(i,300)}catch(o){console.error("twofingers.location niceScroll config error:",o)}}},this.freeze=function(){self.$popup.css("height",self.$popup.outerHeight())},this.unFreeze=function(){self.$popup.css("height","auto")},this.open=function(o){"undefined"!=typeof BX&&BX.hasOwnProperty("Sale")&&BX.Sale.hasOwnProperty("OrderAjaxComponent")&&BX.Sale.OrderAjaxComponent&&(this.isOrderPage=!0,this.callback+="; BX.Sale.OrderAjaxComponent.sendRequest();"),this.$overlay.fadeIn({duration:tf_location_animation_speed,start:this.onOpenStart})},this.onOpenStart=function(){self.$bodyChildren.addClass("tfl-body-blur"),self.$body.addClass("tfl-body-freeze"),tf_location_cities_loaded?(self.reloadScroll(self.$locationsContainer),self.reloadScroll(self.$defaultsContainer),self.onOpenComplete()):(self.$overlay.addClass("tfl-popup-overlay_loading"),self.loadLocations().then(self.onOpenComplete),self.Search.init(),self.initClose(),tf_location_cities_loaded=!0)},this.onOpenComplete=function(){self.$overlay.removeClass("tfl-body-blur tfl-popup-overlay_loading"),self.$popup.removeClass("tfl-body-blur"),self.$popup.addClass("tfl-popup_loaded")},this.onLocationsLoadStart=function(){this.$popup.addClass("tfl-popup_loading")},this.onLocationsLoadComplete=function(){self.$popup.removeClass("tfl-popup_loading")},this.loadLocations=function(){return new Promise(function(o){$.get(self.componentPath+"/functions.php",{request:"getcities",type:self.TfLocation.params.load_type},function(t){t.CITIES.length&&self.addLocations(self.$locationsContainer,t.CITIES,"tfl-popup__with-locations"),t.DEFAULT_CITIES.length&&self.addLocations(self.$defaultsContainer,t.DEFAULT_CITIES,"tfl-popup__with-defaults"),self.addLocationsHandler(self.$popup.find(".tfl-popup__location-link")),o(t)},"json")})},this.addLocations=function(o,t,e,i){var n=o.find(".tfl-popup__list"),s=t.length;if(n.length){var a=$(".tfl__link-container .tfl__link").text().trim();return $.each(t,function(t,e){var l='<li><a class="tfl-popup__location-link" data-id="'+e.id+'" data-name="'+self.TfLocation.clearStr(e.name)+'" data-code="'+self.TfLocation.clearStr(e.code);l+=i?'" data-source="'+i:'" data-source="base',l+='" href="#">'+self.TfLocation.htmlspecialcharsDecode(e.name)+"</a>",e.hasOwnProperty("description")&&(l+='<div class="tf-location__region">'+e.description+"</div>"),l+="</li>",e.name.toLowerCase()!=a.toLowerCase()&&n.append(l),--s||self.reloadScroll(o)}),e&&e.length&&this.$popup.addClass(e),n}},this.canUseNiceScroll=function(){return window.jQuery.fn.jquery.split(".").shift()>2&&!self.TfLocation.isMobile()},this.reloadScroll=function(o){if(window.jQuery)try{o.getNiceScroll().length?o.getNiceScroll().resize():o.niceScroll({scrollspeed:60,mousescrollstep:50,hwacceleration:!0,bouncescroll:!0,zindex:"50",cursorborderradius:"0px",cursorborder:"none",horizrailenabled:!1,cursorcolor:"#666",cursorwidth:"5px",background:"#d5d5d5",autohidemode:"leave",cursoropacitymin:.4})}catch(o){console.error("twofingers.location niceScroll error:",o)}},this.initClose=function(){self.$overlay.on("click",function(o){self.$popup.is(o.target)||0!==self.$popup.has(o.target).length||self.close()}),this.$popup.find(".tfl-popup__close.tfl-popup__close_list").on("click",this.close)},this.isOpened=function(){return self.$popup.is(":visible")},this.close=function(){return self.$overlay.fadeOut(tf_location_animation_speed),self.$bodyChildren.removeClass("tfl-body-blur"),self.$body.removeClass("tfl-body-freeze"),self.$popup.removeClass("tfl-popup_loaded"),!1},this.addLocationsHandler=function($elements){$elements.length&&$elements.on("click",function(e){e.stopPropagation(),e.preventDefault();var location=this,locationId=$(location).data("id"),locationName=$(location).text(),locationCode=$(location).data("code"),$orderLocation=self.$body.find(".tfl__link.tfl__link_order"),$route=self.$body.find(".bx-ui-sls-route"),$saleLocationInput=self.$body.find(".tf_location_city_input");$orderLocation.length&&$route.length&&$route.val(locationName),self.TfLocation.updateLinks(locationId,locationName,locationCode),$saleLocationInput.length&&$saleLocationInput.val(locationCode);var callback=function(response){var actualCallBackHandler=self.callback;"undefined"!=typeof BX&&BX&&BX.onCustomEvent("onTFLocationSetLocation",[response]);try{actualCallBackHandler=actualCallBackHandler.replace("#TF_LOCATION_CITY_ID#",locationId),actualCallBackHandler=actualCallBackHandler.replace("#TF_LOCATION_CITY_NAME#",locationName),eval(actualCallBackHandler)}catch(o){console.error("twofingers.location callback error:",o)}response.redirect&&response.redirect.length&&!self.isOrderPage?window.location.href=response.redirect:response.reload&&response.reload&&!self.isOrderPage?(self.TfLocation.removeURLParameters(["tfl"]),window.location.reload()):self.close()};self.TfLocation.setLocation(locationCode,callback,self.requestUri)})},this.$body.on("keydown",self.onKeyPress)}function TfLocationsPopupSearch(o){var t=this;this.LocationsPopup=o,this.$clear=o.$popup.find(".tfl-popup__clear-field"),this.$searchInput=o.$popup.find(".tfl-popup__search-input"),this.$list=o.$locationsContainer.find(".tfl-popup__list"),this.$noFound=o.$locationsContainer.find(".tfl-popup__nofound-mess"),this.focus=function(){this.$searchInput.focus()},this.init=function(){this.initSearch(),this.$clear.length&&this.$clear.click(function(){t.reset()})},this.showClear=function(){this.$clear.length&&this.$clear.fadeIn(tf_location_animation_speed)},this.hideClear=function(){this.$clear.length&&this.$clear.fadeOut(tf_location_animation_speed)},this.showNoFoundAndDefaults=function(){this.$noFound.length&&(this.$noFound.addClass("tfl-popup__nofound-mess-show"),t.LocationsPopup.reloadScroll(t.LocationsPopup.$locationsContainer)),this.tryToShowDefaults()},this.hideNoFound=function(){this.$noFound.length&&this.$noFound.removeClass("tfl-popup__nofound-mess-show")},this.initSearch=function(){var o;this.$searchInput.keyup(function(){t.LocationsPopup.freeze();var e=$(this).val().toUpperCase();o&&clearTimeout(o),e.length?(t.showClear(),o=setTimeout(function(){t.removeResults(),t.hideNoFound(),t.$list.find(".tfl-popup__location-link").parent().hide(),t.LocationsPopup.$popup.addClass("tfl-popup__with-locations").addClass("tfl-popup_loading"),t.search(e).done(function(o){t.updateResults(o.CITIES),t.LocationsPopup.$popup.removeClass("tfl-popup_loading")})},400)):t.reset()})},this.search=function(o){return this.LocationsPopup.TfLocation.params.ajax_search&&this.LocationsPopup.componentPath.length?this.ajaxSearch(o):this.localSearch(o)},this.updateResults=function(o){o&&o.length?(t.hideNoFound(),t.hideDefaults(),t.LocationsPopup.addLocations(t.LocationsPopup.$locationsContainer,o,"tfl-popup__with-locations","search"),t.LocationsPopup.addLocationsHandler(t.$list.find(".tfl-popup__location-link"))):t.showNoFoundAndDefaults()},this.ajaxSearch=function(o){return $.ajax({type:"POST",url:t.LocationsPopup.componentPath+"/functions.php",data:{request:"find",q:o},dataType:"json"})},this.localSearch=function(o){var e=$.Deferred(),i={CITIES:[],FCITIES:[]},n=[];return t.$list.find("a[data-source=base]").each(function(){var t,e,s=$(this),a=s.siblings(".tf-location__region"),l=s.html().toUpperCase();l.indexOf(o)>=0&&(e={name:t=(t=$(this).html()).substring(0,l.indexOf(o))+"<b>"+t.substring(l.indexOf(o),l.indexOf(o)+o.length)+"</b>"+t.substring(l.indexOf(o)+o.length),id:$(this).data("id"),code:$(this).data("code")},a.length&&(e.description=a.text()),0===l.indexOf(o)?i.CITIES.push(e):n.push(e))}),n.length&&(i.CITIES=i.CITIES.concat(n)),i.CITIES=i.CITIES.map(function(o){return i.CITIES.forEach(function(t){return o.NAME===t.NAME&&o.ID!==t.ID&&(o.SHOW_REGION="Y"),!0}),o}),e.resolve(i)},this.hideDefaults=function(){this.LocationsPopup.$popup.removeClass("tfl-popup__with-defaults")},this.tryToShowDefaults=function(){this.LocationsPopup.$defaultsContainer.find(".tfl-popup__location-link").length&&(this.LocationsPopup.$popup.addClass("tfl-popup__with-defaults"),t.LocationsPopup.reloadScroll(t.LocationsPopup.$defaultsContainer))},this.removeResults=function(){this.$list.find(".tfl-popup__location-link[data-source=search]").parent().remove()},this.reset=function(){t.$searchInput.val.length&&t.$searchInput.val(""),this.hideClear(),this.hideNoFound(),this.removeResults(),t.LocationsPopup.unFreeze();var o=this.$list.find(".tfl-popup__location-link").parent();o.length?o.show():this.LocationsPopup.$popup.removeClass("tfl-popup__with-locations"),this.tryToShowDefaults(),t.LocationsPopup.reloadScroll(t.LocationsPopup.$locationsContainer)}}function TfConfirmPopup(o){var t=this;this.TfLocation=o,this.params=o.params,this.$body=o.$body,this.$bodyChildren=o.$bodyChildren,this.$popup=this.$body.find(".tfl-define-popup").first(),this.componentPath=this.TfLocation.params.path?this.TfLocation.params.path:"",this.$popup.length&&(this.$popup.length>1?this.$popup.first().remove():this.$popup.prependTo(this.$body)),this.close=function(o){return o=!!o,t.$popup.fadeOut(tf_location_animation_speed).data("closed",!0),t.componentPath.length&&$.post(t.componentPath+"/functions.php",{request:"close_confirm_popup",confirm:o?"Y":"N"},function(t){o&&t.reload&&t.reload&&window.location.reload()},"json"),!1},this.open=function(){var o,e,i;this.$popup.length&&(this.setPosition(),$(window).on("resize scroll",function(){t.setPosition()}),o=this.$popup.find(".tfl-popup__close"),e=this.$popup.find(".tfl-define-popup__yes"),i=this.$popup.find(".tfl-define-popup__list"),this.$popup.fadeIn(tf_location_animation_speed),o.on("click",this.close),e.on("click",function(){t.close(!0)}),i.on("click",function(o){t.TfLocation.openLocationsPopup(),o.preventDefault(),o.stopPropagation()}))},this.setPosition=function(){if(!this.$popup.data("closed")){var o,t=$(".tfl__link:visible").not(".tfl__link_order").first();this.TfLocation.isMobile()?this.$popup.removeClass("tfl-define-popup__desktop").addClass("tfl-define-popup__mobile").css("top","auto").css("left","auto").show():(this.$popup.removeClass("tfl-define-popup__mobile").addClass("tfl-define-popup__desktop"),t.length&&t.offset().left+t.width()>=0?((o=t.offset().left+t.width()/2)>$(window).width()-this.$popup.width()/2&&(o=$(window).width()-this.$popup.width()/2),o<this.$popup.width()/2&&(o=this.$popup.width()/2),this.$popup.css("left",o+"px").css("top",t.offset().top+t.outerHeight()+12).show()):this.$popup.hide())}}}!window.BX&&top.BX&&(window.BX=top.BX);