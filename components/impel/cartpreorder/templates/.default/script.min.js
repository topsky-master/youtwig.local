function checkDeviceJs(){if(!$("#devicejs").get(0)){$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!0);var e=location.protocol+"//"+location.hostname+"/local/components/impel/cartpreorder/templates/.default/device.js",a=document.createElement("script");a.type="text/javascript",a.id="devicejs",a.src=e,$(a).appendTo($("head"));var r=setInterval(function(){"undefined"!=typeof device&&(clearInterval(r),r=null,$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!1))},200)}}function bindPreOrderItems(){phonePlaceholder="+79_________",phoneMask="+79000000000",$("#PAYER_PHONE").attr("autocomplete",!1),$("#PAYER_PHONE").attr("placeholder",phonePlaceholder);var e={onKeyPress:function(e,a,r,t){$(r).get(0)&&0===$(r).val().indexOf("+78")&&$(r).val($(r).val().replace("+78","+79"))}};$("#PAYER_PHONE").mask(phoneMask,e),$(".btn-preorder").get(0)&&$(".btn-preorder").bind("click",function(){checkDeviceJs(),$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!1),$("#modalOCBuy .form-group").css("display","table"),$("#oc_error .errors")[0].innerHTML="",$("#oc_order")[0].innerHTML="",$("#oc_error,#oc_order").addClass("hidden"),$("#PRODUCT_ID").val($(this).attr("data-product-id")),resultAnswer=$.trim($("#modalOCBuy #resultpOk").eq(0).text()),$("#modalOCBuy").find(".modal-title").find(".pre_order").removeClass("hidden").end().find(".order").addClass("hidden"),$("#PREORDER_ACTION").val("/ajax_cart/preorder.php")}),$(".btn-oneclick").get(0)&&$(".btn-oneclick").bind("click",function(){checkDeviceJs(),$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!1),$("#modalOCBuy .form-group").css("display","table"),$("#oc_error .errors")[0].innerHTML="",$("#oc_order")[0].innerHTML="",$("#oc_error,#oc_order").addClass("hidden"),$("#PRODUCT_ID").val($(this).attr("data-product-id")),resultAnswer=$.trim($("#modalOCBuy #resultOk").eq(0).text()),$("#modalOCBuy").find(".modal-title").find(".order").removeClass("hidden").end().find(".pre_order").addClass("hidden"),$("#PREORDER_ACTION").val("/ajax_cart/fastoder.php")}),$("#PAY_ONE_CLICK").bind("click",function(){var e=this;$(e).attr("disabled",!0);var a=location.protocol+"//"+location.hostname+"/include/resolution.php?";a+="&user_resolution="+$(window).width()+"x"+$(window).height(),a+="&deviceinfo="+encodeURIComponent(device.type+" "+device.os+" "+device.orientation),jQuery.ajax({url:a,dataType:"json",async:!0,processData:!0}).done(function(a){var r=$("#PREORDER_ACTION").val(),t=location.href;$("#order_one_click_form .form-group").removeClass("has-error"),$("#order_one_click_form .form-group").removeClass("has-success");var o=$("#PRODUCT_ID").val(),d=$("#PAYER_NAME")[0].value,i=!1;(d=$.trim(d)).length>3?$("#modalOCBuy .name-group").addClass("has-success"):($("#modalOCBuy .name-group").addClass("has-error"),i=!0);var s=$("#PAYER_PHONE")[0].value;(s=$.trim(s)).length>3?$("#modalOCBuy .phone-group").addClass("has-success"):($("#modalOCBuy .phone-group").addClass("has-error"),i=!0);var n=$("#PAYER_EMAIL")[0].value;(n=$.trim(n)).length>5&&-1!==n.indexOf("@")&&-1!==n.indexOf(".")?$("#modalOCBuy .email-group").addClass("has-success"):($("#modalOCBuy .email-group").addClass("has-error"),i=!0),$("#oc_error .errors")[0].innerHTML="",$("#oc_order")[0].innerHTML="",$("#oc_error,#oc_order").addClass("hidden"),i?$(e).attr("disabled",!1):jQuery.ajax({url:r,method:"POST",dataType:"json",async:!0,processData:!0,data:{PRODUCT_ID:o,PAYER_NAME:d,PAYER_PHONE:s,PAYER_EMAIL:n,AJAX_LOCATION:t}}).done(function(a){if(a.ERROR){if($("#oc_error").removeClass("hidden"),$(e).attr("disabled",!1),a.ERROR&&a.ERROR.length)for(var t=0;t<a.ERROR.length;t++)$("#oc_error .errors")[0].innerHTML+='<div class="alert alert-danger text-left" role="alert"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span><span class="sr-only">Error:</span> '+a.ERROR[t]+"</div>"}else if(a.ORDER_ID){$.cookie("BITRIX_SM_ispreodered"+o,!0,{expires:30,path:"/",domain:location.hostname,secure:"https:"==location.protocol}),$(".btn-preorder-"+o).attr("disabled",!0),$("#modalOCBuy .form-group").css("display","none"),$("#oc_order")[0].innerHTML=resultAnswer.replace("#",a.ORDER_ID),$("#oc_order").removeClass("hidden");var d=location.protocol+"//"+location.hostname+"/include/datalayer.php?ORDER_ID="+a.ORDER_ID;jQuery.getJSON(d,function(e){if(e&&void 0!==e.success&&1==e.success){if(window.dataLayer=window.dataLayer||[],"/ajax_cart/fastoder.php"==r)var t="oneclick";if("/ajax_cart/preorder.php"==r)t="preorder";var o={id:a.ORDER_ID};t&&(o.goal_id=t),dataLayer.push({ecommerce:{purchase:{actionField:o,products:e.products}}})}})}else $(e).attr("disabled",!1)}).fail(function(a,r){$(e).attr("disabled",!1)})}).fail(function(a,r){$(e).attr("disabled",!1)})})}function bindOrderItems(){$("#modalCart").get(0)&&($("#modalCart").on("hidden.bs.modal",function(e){$("#modalCart").css("opacity","0")}),$("#modalCart").on("show.bs.modal",function(e){$(".alert-danger",$("#modalCart")).addClass("hidden"),$(".cart-picture",$("#modalCart")).addClass("hidden"),$(".h4",$("#modalCart")).addClass("hidden"),$(".btn-primary",$("#modalCart")).addClass("hidden"),$("#errorResult",$("#modalCart")).html("");var a=e.relatedTarget,r=$(e.relatedTarget).parents(".product-item");if($("#product-item img").get(0))var t=$("#product-item img").attr("src");else t=$(r).attr("data-src");$(".cart-picture",$("#modalCart")).css({"background-image":"url("+t+")"}),$.trim($(".item-title",r).get(0))?$("p.h4",$("#modalCart")).html($.trim($(".item-title",r).text())):$("p.h4",$("#modalCart")).html($.trim($(r).attr("data-title")));var o=$(a).attr("data-product-id"),d=location.protocol+"//"+location.hostname+"/include/addtocart.php?action=addbasket&id="+o,i=$(".product_cart_name",r).get(0);i&&(d+="&product_name="+$(i).val());jQuery.ajax({url:d,dataType:"json",async:!0,processData:!0}).done(function(e){if(e&&void 0!==e.STATUS)if("OK"==e.STATUS){if(void 0!==e.FROM_PROVIDER)return location.replace("/personal/provider/"),!1;$(".cart-picture",$("#modalCart")).removeClass("hidden"),$(".h4",$("#modalCart")).removeClass("hidden"),$(".btn-primary",$("#modalCart")).removeClass("hidden");var a=$.trim($("#miniCart .acq").text());a=parseInt(a),a=isNaN(a)?0:a,++a,$("#miniCart .acq").html(a),$("#modalCart").css("opacity","1.0");var r=location.protocol+"//"+location.hostname+"/include/datalayer.php?ID="+o;jQuery.getJSON(r,function(e){e&&void 0!==e.success&&1==e.success&&(window.dataLayer=window.dataLayer||[],dataLayer.push({ecommerce:{add:{products:[{id:e.id,name:e.name,price:e.price,brand:e.brand,category:e.category,quantity:1}]}}}))})}else"ERROR"==e.STATUS&&($(".alert-danger",$("#modalCart")).removeClass("hidden"),$(".cart-picture",$("#modalCart")).addClass("hidden"),$(".h4",$("#modalCart")).addClass("hidden"),$(".btn-primary",$("#modalCart")).addClass("hidden"),void 0!==e.MESSAGE&&e.MESSAGE&&($("#errorResult",$("#modalCart")).html(e.MESSAGE),$("#modalCart").css("opacity","1.0")))})}))}$(function(){bindPreOrderItems(),bindOrderItems()});