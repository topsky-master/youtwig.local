function checkDeviceJs(){if(!$("#devicejs").get(0)){$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!0);var a=location.protocol+"//"+location.hostname+"/local/components/impel/cartpreorder/templates/.default/device.js",e=document.createElement("script");e.type="text/javascript",e.id="devicejs",e.src=a,$(e).appendTo($("head"));var r=setInterval(function(){"undefined"!=typeof device&&(clearInterval(r),r=null,$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!1))},200)}}function bindPreOrderItems(){phonePlaceholder="+79_________",phoneMask="+79000000000",$("#PAYER_PHONE").attr("autocomplete",!1),$("#PAYER_PHONE").attr("placeholder",phonePlaceholder);var a={onKeyPress:function(a,e,r,t){$(r).get(0)&&0===$(r).val().indexOf("+78")&&$(r).val($(r).val().replace("+78","+79"))}};$("#PAYER_PHONE").mask(phoneMask,a),$(".btn-preorder").get(0)&&$(".btn-preorder").bind("click",function(){checkDeviceJs(),$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!1),$("#modalOCBuy .form-group").css("display","table"),$("#oc_error .errors")[0].innerHTML="",$("#oc_order")[0].innerHTML="",$("#oc_error,#oc_order").addClass("hidden"),$("#PRODUCT_ID").val($(this).attr("data-product-id")),resultAnswer=$.trim($("#modalOCBuy #resultpOk").eq(0).text()),$("#modalOCBuy").find(".modal-title").find(".pre_order").removeClass("hidden").end().find(".order").addClass("hidden"),$("#PREORDER_ACTION").val("/ajax_cart/preorder.php")}),$(".btn-oneclick").get(0)&&$(".btn-oneclick").bind("click",function(){checkDeviceJs(),$("#PAY_ONE_CLICK").get(0)&&$("#PAY_ONE_CLICK").attr("disabled",!1),$("#modalOCBuy .form-group").css("display","table"),$("#oc_error .errors")[0].innerHTML="",$("#oc_order")[0].innerHTML="",$("#oc_error,#oc_order").addClass("hidden"),$("#PRODUCT_ID").val($(this).attr("data-product-id")),resultAnswer=$.trim($("#modalOCBuy #resultOk").eq(0).text()),$("#modalOCBuy").find(".modal-title").find(".order").removeClass("hidden").end().find(".pre_order").addClass("hidden"),$("#PREORDER_ACTION").val("/ajax_cart/fastoder.php")}),$("#PAY_ONE_CLICK").bind("click",function(){var a=this;$(a).attr("disabled",!0);var e=location.protocol+"//"+location.hostname+"/include/resolution.php?";e+="&user_resolution="+$(window).width()+"x"+$(window).height(),e+="&deviceinfo="+encodeURIComponent(device.type+" "+device.os+" "+device.orientation),jQuery.ajax({url:e,dataType:"json",async:!0,processData:!0}).done(function(e){var r=$("#PREORDER_ACTION").val(),t=location.href;$("#order_one_click_form .form-group").removeClass("has-error"),$("#order_one_click_form .form-group").removeClass("has-success");var o=$("#PRODUCT_ID").val(),d=$("#PAYER_NAME")[0].value,i=!1;(d=$.trim(d)).length>3?$("#modalOCBuy .name-group").addClass("has-success"):($("#modalOCBuy .name-group").addClass("has-error"),i=!0);var n=$("#PAYER_PHONE")[0].value;(n=$.trim(n)).length>3?$("#modalOCBuy .phone-group").addClass("has-success"):($("#modalOCBuy .phone-group").addClass("has-error"),i=!0);var s=$("#PAYER_EMAIL")[0].value;(s=$.trim(s)).length>5&&-1!==s.indexOf("@")&&-1!==s.indexOf(".")?$("#modalOCBuy .email-group").addClass("has-success"):($("#modalOCBuy .email-group").addClass("has-error"),i=!0),$("#oc_error .errors")[0].innerHTML="",$("#oc_order")[0].innerHTML="",$("#oc_error,#oc_order").addClass("hidden"),i?$(a).attr("disabled",!1):jQuery.ajax({url:r,method:"POST",dataType:"json",async:!0,processData:!0,data:{PRODUCT_ID:o,PAYER_NAME:d,PAYER_PHONE:n,PAYER_EMAIL:s,AJAX_LOCATION:t}}).done(function(e){if(e.ERROR){if($("#oc_error").removeClass("hidden"),$(a).attr("disabled",!1),e.ERROR&&e.ERROR.length)for(var t=0;t<e.ERROR.length;t++)$("#oc_error .errors")[0].innerHTML+='<div class="alert alert-danger text-left" role="alert"><span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span><span class="sr-only">Error:</span> '+e.ERROR[t]+"</div>"}else if(e.ORDER_ID){$.cookie("BITRIX_SM_ispreodered"+o,!0,{expires:30,path:"/",domain:location.hostname,secure:"https:"==location.protocol}),$(".btn-preorder-"+o).attr("disabled",!0),$("#modalOCBuy .form-group").css("display","none"),$("#oc_order")[0].innerHTML=resultAnswer.replace("#",e.ORDER_ID),$("#oc_order").removeClass("hidden");var d=location.protocol+"//"+location.hostname+"/include/datalayer.php?ORDER_ID="+e.ORDER_ID;jQuery.getJSON(d,function(a){if(a&&void 0!==a.success&&1==a.success){if(window.dataLayer=window.dataLayer||[],"/ajax_cart/fastoder.php"==r)var t="oneclick";if("/ajax_cart/preorder.php"==r)t="preorder";var o={id:e.ORDER_ID};t&&(o.goal_id=t),dataLayer.push({ecommerce:{purchase:{actionField:o,products:a.products}}})}})}else $(a).attr("disabled",!1)}).fail(function(e,r){$(a).attr("disabled",!1)})}).fail(function(e,r){$(a).attr("disabled",!1)})})}function bindOrderItems(){$("#modalCart").get(0)&&($("#modalCart").on("hidden.bs.modal",function(a){$("#modalCart").css("opacity","0")}),$("#modalCart").on("show.bs.modal",function(a){$(".alert-danger",$("#modalCart")).addClass("hidden"),$(".cart-picture",$("#modalCart")).addClass("hidden"),$(".h4",$("#modalCart")).addClass("hidden"),$(".btn-primary",$("#modalCart")).addClass("hidden"),$("#errorResult",$("#modalCart")).html("");var e=a.relatedTarget,r=$(a.relatedTarget).parents(".product-item");if($(".piiw img",r).get(0))var t=$(".piiw img",r).attr("src");else t=$(r).attr("data-src");$(".cart-picture",$("#modalCart")).css({"background-image":"url("+t+")"}),$.trim($(".item-title",r).get(0))?$("p.h4",$("#modalCart")).html($.trim($(".item-title",r).text())):$("p.h4",$("#modalCart")).html($.trim($(r).attr("data-title")));var o=$(e).attr("data-product-id"),d=$(e).parent().find(".order_quantity").val();d="undefined"!=d&&d?d:1;var i=location.protocol+"//"+location.hostname+"/include/addtocart.php?action=addbasket&id="+o+"&quantity="+d,n=$(".product_cart_name",r).get(0);n&&(i+="&product_name="+$(n).val());jQuery.ajax({url:i,dataType:"json",async:!0,processData:!0}).done(function(a){if(a&&void 0!==a.STATUS)if("OK"==a.STATUS){if(void 0!==a.FROM_PROVIDER)return location.replace("/personal/provider/"),!1;$(".cart-picture",$("#modalCart")).removeClass("hidden"),$(".h4",$("#modalCart")).removeClass("hidden"),$(".btn-primary",$("#modalCart")).removeClass("hidden");var e=$.trim($("#miniCart .acq").text());e=parseInt(e),e=isNaN(e)?0:e,++e,$("#miniCart .acq").html(e),$("#modalCart").css("opacity","1.0");var r=location.protocol+"//"+location.hostname+"/include/datalayer.php?ID="+o;jQuery.getJSON(r,function(a){a&&void 0!==a.success&&1==a.success&&(window.dataLayer=window.dataLayer||[],dataLayer.push({ecommerce:{add:{products:[{id:a.id,name:a.name,price:a.price,brand:a.brand,category:a.category,quantity:d}]}}}))})}else"ERROR"==a.STATUS&&($(".alert-danger",$("#modalCart")).removeClass("hidden"),$(".cart-picture",$("#modalCart")).addClass("hidden"),$(".h4",$("#modalCart")).addClass("hidden"),$(".btn-primary",$("#modalCart")).addClass("hidden"),void 0!==a.MESSAGE&&a.MESSAGE&&($("#errorResult",$("#modalCart")).html(a.MESSAGE),$("#modalCart").css("opacity","1.0")))})}))}function bindQuantity(){$(".btn-buy").each(function(){$(this).data("max-quantity");let a=$(this).parent().find(".order_quantity");$(a).get(0)&&$(a).each(function(){$(this).attr("number")||($(this).attr("number",!0),$(this).bootstrapNumber())})})}$(function(){bindPreOrderItems(),bindOrderItems(),bindQuantity()});